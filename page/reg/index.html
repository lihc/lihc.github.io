<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hexo">
    <title>Hexo</title>
    <link rel="shortcut icon" href="/images/favicon.svg" type="image/x-icon">
    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/article.css">
    <link rel="stylesheet" href="/css/paginator.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/markdown-body.css">
    <link rel="stylesheet" href="/css/medis.css">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script src="/js/show-menus.js"></script>
    <script src="/js/moment-with-locales.js"></script>
    <script src="/js/time-ago.js"></script>
</head>

<body>
    <header>
        <div class="nvabar-container container">
            <h1 class="title">
                <a class="logo" href="/">
                    <img src="/images/favicon.svg">
                </a>
                <a class="site-title" href="/">一条理想鱼</a>
            </h1>
            <nav class="menus" id="navbar">
                <div class="nav-head">
                    <h2>MENU</h2>
                    <a href="#"><ion-icon name="close"></ion-icon></a>
                </div>
                <div class="navbar">
                    <a class="menu " href="/">Home</a>
                    <a class="menu " href="/archives">Archives</a>
                    <a class="menu " href="/categories">Categories</a>
                    <a class="menu " href="/tags">Tags</a>
                    <a class="menu " href="/links">Links</a>
                    <a class="menu " href="/about">About</a>
                </div>
                <div class="nva-foot"></div>
            </nav>
            <div class="quickly">
                <a class="item github" target="_blank" href="https://github.com/lihaicheng-cn"><ion-icon name="logo-github"></ion-icon></a>
                <a class="item search" href="#"><ion-icon name="search"></ion-icon></a>
                <a class="item media-menus" id="show-menus"><ion-icon name="menu"></ion-icon></a>
            </div>
        </div>
    </header>
    <main>
        <div class="container main-content">
            <div class="content" style="flex: 1;">
                <article class="article card post">
                    <div class="metadata">
                        <span><time dateTime="2025-01-23T10:38:24.694Z">2025-01-23</time>发表</span>
                        <span>9 分钟读完 (大约1275个字)</span>
                    </div>
                    <h1 class="post-title">Undefined</h1>
                    <div class="markdown-body">
                        <h1 id="通过-registry-2-加速国外镜像源">
                            <a href="#通过-registry-2-加速国外镜像源" class="headerlink" title="通过 registry:2 加速国外镜像源"></a>通过 registry:2 加速国外镜像源
                        </h1>
                        <p>registry 镜像仓库：<a target="_blank" rel="noopener" href="https://hub.docker.com/_/registry">https://hub.docker.com/_/registry</a>
                        </p>
                        <p>distribution 官网：<a target="_blank" rel="noopener" href="https://distribution.github.io/distribution/">https://distribution.github.io/distribution/</a>
                        </p>
                        <p>因为一些原因，在国内访问 <code>registry.k8s.io</code>、<code>quay.io</code> 等镜像源非常困难，所以当有一台中国大陆以外的服务器时，可以利用 registry 注册表作为拉取缓存。</p>
                        <blockquote>
                            <p>官网文档：<a target="_blank" rel="noopener" href="https://distribution.github.io/distribution/recipes/mirror/">https://distribution.github.io/distribution/recipes/mirror/</a>
                            </p>
                            <h3 id="Solution">
                                <a href="#Solution" class="headerlink" title="Solution"></a>Solution
                            </h3>
                            <p>The Registry can be configured as a pull through cache. In this mode a Registry responds to all normal docker pull requests but stores all content locally.</p>
                        </blockquote>
                        <h2 id="一、环境准备">
                            <a href="#一、环境准备" class="headerlink" title="一、环境准备"></a>一、环境准备
                        </h2>
                        <p>开始之前需要准备的一些必需品</p>
                        <ul>
                            <li>
                                <input checked="" disabled="" type="checkbox"> 一台可以公网访问的服务器（服务器需要具备访问 registry.k8s.io 的能力）
                            </li>
                            <li>
                                <input checked="" disabled="" type="checkbox"> （可选）一个可以访问的二级域名
                            </li>
                        </ul>
                        <h2 id="二、搭建服务">
                            <a href="#二、搭建服务" class="headerlink" title="二、搭建服务"></a>二、搭建服务
                        </h2>
                        <h3 id="1-功能实现">
                            <a href="#1-功能实现" class="headerlink" title="1. 功能实现"></a>1. 功能实现
                        </h3>
                        <p>首先利用 docker 进行基本功能实现，后续考虑优化。</p>
                        <h4 id="a-拉取-registry-镜像">
                            <a href="#a-拉取-registry-镜像" class="headerlink" title="a. 拉取 registry 镜像"></a>a. 拉取 registry 镜像
                        </h4>
                        <p>使用 <code>docker pull</code> 拉取 registry:2 镜像</p>
                        <figure class="highlight plaintext">
                            <table>
                                <tr>
                                    <td class="gutter">
                                        <pre><span class="line">1</span><br></pre>
                                    </td>
                                    <td class="code">
                                        <pre><span class="line">docker pull registry:2</span><br></pre>
                                    </td>
                                </tr>
                            </table>
                        </figure>

                        <h4 id="b-创建-registry-容器">
                            <a href="#b-创建-registry-容器" class="headerlink" title="b. 创建 registry 容器"></a>b. 创建 registry 容器
                        </h4>
                        <p>使用 <code>docker run</code> 创建容器，映射 5000 端口，名称为 registry，使用镜像 registry:2</p>
                        <figure class="highlight plaintext">
                            <table>
                                <tr>
                                    <td class="gutter">
                                        <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                    </td>
                                    <td class="code">
                                        <pre><span class="line">docker run -d -p 5000:5000 --name registry registry:2 -e REGISTRY_PROXY_REMOTEURL=&quot;https://registry.k8s.io&quot;</span><br><span class="line"># 通过 -e 参数设置变量 REGISTRY_PROXY_REMOTEURL，将 registry.k8s.io 作为缓存服务的上游</span><br></pre>
                                    </td>
                                </tr>
                            </table>
                        </figure>

                        <p>还可以通过设置配置文件实现</p>
                        <figure class="highlight plaintext">
                            <table>
                                <tr>
                                    <td class="gutter">
                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                    </td>
                                    <td class="code">
                                        <pre><span class="line">proxy:</span><br><span class="line">  remoteurl: https://registry-1.docker.io</span><br><span class="line">  username: [username]</span><br><span class="line">  password: [password]</span><br><span class="line">  ttl: 168h</span><br><span class="line"># registry 官网为 https://registry-1.docker.io, 按需配置。</span><br></pre>
                                    </td>
                                </tr>
                            </table>
                        </figure>

                        <h4 id="c-验证服务的可用性">
                            <a href="#c-验证服务的可用性" class="headerlink" title="c. 验证服务的可用性"></a>c. 验证服务的可用性
                        </h4>
                        <p>此时可以跳转到 <a href="https://www.lihaicheng.com/page/reg/#%E4%B8%89%E3%80%81%E9%85%8D%E7%BD%AE%E5%AE%A2%E6%88%B7%E7%AB%AF">第三节</a> 配置客户端并且在确保网络连通性正常后进行验证。</p>
                        <p>验证完成后，查看 registry 容器官网，无法镜像另外一个域。所以当需要同时代理缓存 <code>docker.io</code>、<code>quay.io</code> 时，就需要修改映射的端口和上游地址，启动新容器，对加速镜像分别进行缓存。</p>
                        <p>compose.yml 说明：</p>
                        <ul>
                            <li>services：服务，名称分别为：registry_docker、registry_k8s、registry_quay</li>
                            <li>environment：变量 <code>REGISTRY_PROXY_REMOTEURL</code>，值为：<a target="_blank" rel="noopener" href="https://registry-1.docker.io、https//registry.k8s.io%E3%80%81https://quay.io">https://registry-1.docker.io、https://registry.k8s.io、https://quay.io</a>
                            </li>
                            <li>healthcheck：健康检查，<code>nc -z localhost 5000</code>
                            </li>
                            <li>image：镜像，使用 registry:2 作为容器的镜像</li>
                            <li>ports：映射端口，映射宿主机 5001- 5003 到容器 5000 端口</li>
                            <li>volumes：挂载卷，<code>- ./config.yml:/etc/docker/registry/config.yml</code>、<code>- /var/lib/registry/cache/[SERVER_NAME]:/var/lib/registry</code>、<code>- ./htpasswd:/path/to/htpasswd</code>
                            </li>
                        </ul>
                        <h3 id="3-使用-Nginx-进行代理">
                            <a href="#3-使用-Nginx-进行代理" class="headerlink" title="3. 使用 Nginx 进行代理"></a>3. 使用 Nginx 进行代理
                        </h3>
                        <p>当部署完成后，在配置客户端时需要分别指向服务的【地址】+【端口】，我们希望客户端不需要考虑具体哪个服务对应哪个端口，此时可以利用 Nginx 进行反向代理。参考：<a target="_blank" rel="noopener" href="https://distribution.github.io/distribution/recipes/nginx/">Authenticate proxy with nginx</a>
                        </p>
                        <h4 id="配置-upstream-后端服务">
                            <a href="#配置-upstream-后端服务" class="headerlink" title="配置 upstream 后端服务"></a>配置 upstream 后端服务
                        </h4>
                        <h4 id="对-nginx-配置文件的解释说明">
                            <a href="#对-nginx-配置文件的解释说明" class="headerlink" title="对 nginx 配置文件的解释说明"></a>对 nginx 配置文件的解释说明
                        </h4>
                        <p>
                            <strong>使用 containerd 拉取 registry.k8s.io&#x2F;pause:3.6 镜像，观察 nginx 日志</strong>
                        </p>
                        <figure class="highlight plaintext">
                            <table>
                                <tr>
                                    <td class="gutter">
                                        <pre><span class="line">1</span><br></pre>
                                    </td>
                                    <td class="code">
                                        <pre><span class="line">127.0.0.1 - - [28/Nov/2023:13:50:25 +0800] &quot;HEAD /v2/pause/manifests/3.6?ns=registry.k8s.io HTTP/1.1&quot; 200 0 &quot;-&quot; &quot;containerd/v1.6.21&quot;</span><br></pre>
                                    </td>
                                </tr>
                            </table>
                        </figure>

                        <p>观察 nginx 日志可以发现，当 containerd 在请求不同域时的参数，发现具有相同的 <code>?ns=</code> 参数，所以我们可以根据参数，将请求代理到对应的服务，通过定义 map 来设置变量 <code>$upstream</code> 的值。</p>
                        <p>
                            <strong>使用 docker 拉取 centos:7 镜像，观察 nginx 日志</strong>
                        </p>
                        <figure class="highlight plaintext">
                            <table>
                                <tr>
                                    <td class="gutter">
                                        <pre><span class="line">1</span><br></pre>
                                    </td>
                                    <td class="code">
                                        <pre><span class="line">127.0.0.1 - - [29/Nov/2023:14:15:48 +0800] &quot;HEAD /v2/library/centos/manifests/7 HTTP/1.1&quot; 200 0 &quot;-&quot; &quot;docker/24.0.7 go/go1.20.10 git-commit/311b9ff kernel/5.15.0-89-generic os/linux arch/amd64 UpstreamClient(Docker-Client/24.0.7 \x5C(linux\x5C))&quot;</span><br></pre>
                                    </td>
                                </tr>
                            </table>
                        </figure>

                        <p>使用 docker 拉取镜像时发现，docker 并没有像 containerd 一样，请求中包含 <code>?ns=docker.io</code> 参数，而且 docker 的 <code>/etc/docker/daemon.json</code> 文件也不支持对其他镜像源配置加速，所以可以通过识别客户端类型，将 docker 客户端的请求全部转发到 <code>$upstream:registry-docker</code> 的后端。</p>
                        <p>通过设置 nginx server 配置，当请求 <code>$http_user_agent</code> 包含 “Docker-Client” 时，设置 $upstream &#x3D; registry-docker</p>
                        <figure class="highlight plaintext">
                            <table>
                                <tr>
                                    <td class="gutter">
                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                    </td>
                                    <td class="code">
                                        <pre><span class="line">if ($http_user_agent ~* Docker-Client) &#123;</span><br><span class="line">    set $upstream registry-docker;</span><br><span class="line">&#125;</span><br></pre>
                                    </td>
                                </tr>
                            </table>
                        </figure>

                        <p>
                            <strong>当 Nginx 开启基本身份认证后，服务对于 Docker 客户端的处理</strong>
                        </p>
                        <p>nginx 开启基本身份认证</p>
                        <figure class="highlight plaintext">
                            <table>
                                <tr>
                                    <td class="gutter">
                                        <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                    </td>
                                    <td class="code">
                                        <pre><span class="line">auth_basic &quot;Registry realm&quot;;</span><br><span class="line">auth_basic_user_file /etc/nginx/conf.d/nginx.htpasswd;</span><br></pre>
                                    </td>
                                </tr>
                            </table>
                        </figure>

                        <p>此时当服务器接收到请求后，会返回客户端 <code>HTTP 401</code> 状态码，要求客户端进行身份认证。</p>
                        <p>只需要修改配置文件或使用命令行参数，containerd 可以进行身份认证操作，但是 docker 却无法处理，服务器返回 <code>HTTP 401</code> 后，docker 客户端会认为镜像缓存不可用，并且 <code>docker login</code> 登录后仍然无法下载镜像。</p>
                        <p>所以，只能对 docker 客户端取消身份认证，配置 nginx.conf 文件</p>
                        <figure class="highlight plaintext">
                            <table>
                                <tr>
                                    <td class="gutter">
                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                    </td>
                                    <td class="code">
                                        <pre><span class="line">map $http_user_agent $auth_basic_value &#123;</span><br><span class="line">    default &quot;Registry realm&quot;;</span><br><span class="line">    &quot;~*Docker-Client&quot; off;</span><br><span class="line">&#125;</span><br><span class="line"># --- &#123;server&#125; ---</span><br><span class="line">auth_basic $auth_basic_value;</span><br><span class="line">auth_basic_user_file /etc/nginx/conf.d/nginx.htpasswd;</span><br></pre>
                                    </td>
                                </tr>
                            </table>
                        </figure>

                        <p>通过识别请求 <code>$http_user_agent</code> 中是否包含 “Docker-Client” 字段，配置基本身份认证 <code>auth_basic</code> 为 <code>off</code> 。</p>
                        <p>这样，当请求客户端为 docker 时，将不再进行身份验证。</p>
                    </div>
                </article>
            </div>
            <div class="sidebar">
                <div class="card profile">
                    <img src="https://cravatar.cn/avatar/d0e94b8b1f46baf4397bcfadbc231ad2?s=128" style="clip-path:circle(50% at center);" onerror="this.style=&#039;&#039;">
                    <h2 class="author">白羊</h2>
                    <ul class="info">
                        <li>
                            <span>POSTS</span>
                            <a href="/archives">23</a>
                        </li>
                        <li>
                            <span>CATEGORIES</span>
                            <a href="/categories">7</a>
                        </li>
                        <li>
                            <span>TAGS</span>
                            <a href="/tags">7</a>
                        </li>
                    </ul>
                    <a class="follow-me" href="/rss">Forrow Me</a>
                    <div class="social">
                        <a target="_blank" rel="noopener"><ion-icon name="logo-github"></ion-icon></a>
                        <a target="_blank" rel="noopener"><ion-icon name="logo-twitter"></ion-icon></a>
                        <a target="_blank" rel="noopener" href="https://www.lihaicheng.com"><ion-icon name="logo-rss"></ion-icon></a>
                        <a href="mailto:undefined"><ion-icon name="mail"></ion-icon></a>
                    </div>
                </div>
                <div class="card side-archives">
                    <h3 class="side-title">ARCHIVES</h3>
                    <div>
                        <a class="archive-link" href="/archives/2026/01/">Jan 2026<span class="archive-count">1</span>
                        </a>
                        <a class="archive-link" href="/archives/2025/01/">Jan 2025<span class="archive-count">10</span>
                        </a>
                        <a class="archive-link" href="/archives/2024/11/">Nov 2024<span class="archive-count">2</span>
                        </a>
                        <a class="archive-link" href="/archives/2024/01/">Jan 2024<span class="archive-count">10</span>
                        </a>
                    </div>
                </div>
                <div class="card side-categories">
                    <h3 class="side-title">CATEGORIES</h3>
                    <div>
                        <a class="category-link" href="/categories/Hello/">Hello<span class="category-count">1</span>
                        </a>
                        <a class="category-link" href="/categories/Linux/">Linux<span class="category-count">2</span>
                        </a>
                        <a class="category-link" href="/categories/%E4%B8%80%E7%BA%A7%E5%88%86%E7%B1%BB/">一级分类<span class="category-count">1</span>
                        </a>
                        <a class="category-link" href="/categories/%E4%B8%80%E7%BA%A7%E5%88%86%E7%B1%BB/%E4%BA%8C%E7%BA%A7%E5%88%86%E7%B1%BB/">二级分类<span class="category-count">1</span>
                        </a>
                        <a class="category-link" href="/categories/%E4%B8%80%E7%BA%A7%E5%88%86%E7%B1%BB/%E4%BA%8C%E7%BA%A7%E5%88%86%E7%B1%BB/%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB/">三级分类<span class="category-count">1</span>
                        </a>
                        <a class="category-link" href="/categories/%E4%B8%80%E7%BA%A7%E5%88%86%E7%B1%BB/%E4%BA%8C%E7%BA%A7%E5%88%86%E7%B1%BB/%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB/%E5%9B%9B%E7%BA%A7%E5%88%86%E7%B1%BB/">四级分类<span class="category-count">1</span>
                        </a>
                        <a class="category-link" href="/categories/%E4%B8%80%E7%BA%A7%E5%88%86%E7%B1%BB/%E4%BA%8C%E7%BA%A7%E5%88%86%E7%B1%BB/%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB/%E5%9B%9B%E7%BA%A7%E5%88%86%E7%B1%BB/%E4%BA%94%E7%BA%A7%E5%88%86%E7%B1%BB/">五级分类<span class="category-count">1</span>
                        </a>
                    </div>
                </div>
                <div class="card side-tags">
                    <h3 class="side-title">TAGS</h3>
                    <div>
                        <a class="tag-link" href="/tags/Cgroup/" rel="tag">Cgroup<span class="tag-count">2</span>
                        </a>
                        <a class="tag-link" href="/tags/Git/" rel="tag">Git<span class="tag-count">1</span>
                        </a>
                        <a class="tag-link" href="/tags/Hexo/" rel="tag">Hexo<span class="tag-count">1</span>
                        </a>
                        <a class="tag-link" href="/tags/Kubernetes/" rel="tag">Kubernetes<span class="tag-count">1</span>
                        </a>
                        <a class="tag-link" href="/tags/NodeJs/" rel="tag">NodeJs<span class="tag-count">1</span>
                        </a>
                        <a class="tag-link" href="/tags/World/" rel="tag">World<span class="tag-count">1</span>
                        </a>
                        <a class="tag-link" href="/tags/%E5%AE%B9%E5%99%A8/" rel="tag">容器<span class="tag-count">2</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer></footer>
</body>

</html>